---
import Input from '@/components/form/Input.astro'
import Select from '@/components/form/Select.astro'
import Button from '@/components/ui/Button.astro'
import { countries } from '@/constants/countries'
import MainLayout from '@/layouts/MainLayout.astro'
import type { InfoUser } from '@/types/user'
import TitleForPage from '@/components/ui/TitleForPage.astro'

import { Image } from 'astro:assets'
import Icon from '@/components/ui/Icon.astro'

const getUser = (await Astro.session?.get('user')) as InfoUser
const { PROJECT_URL } = import.meta.env

const name = getUser?.name
const lastName = getUser?.last_name
const email = getUser?.email
const country = getUser?.country
const zip_code = getUser?.zip_code

const getInitialsNameAndLastName = (name: string, lastName: string) => name.charAt(0) + lastName.charAt(0)

const initials = getInitialsNameAndLastName(name, lastName).toUpperCase()
const hasPhoto = getUser?.photo === null || getUser?.photo === '{}'
const photo = hasPhoto ? '' : `${PROJECT_URL}${getUser.photo}`
const isHiddenPhoto = hasPhoto === false ? '' : 'hidden'
---

<MainLayout title="Perfil">
  <div class="mx-auto max-w-7xl">
    <TitleForPage title="Consultar información del perfil" />
    <div>
      <section class="mb-10 rounded-lg bg-white p-6 shadow shadow-custom-blue3/20">
        <div class="mb-5 border-b border-gray-200 pb-6">
          <h2 class="text-lg font-semibold">Foto de Perfil</h2>
        </div>
        <div class="flex flex-col items-center gap-6 md:flex-row">
          <img
            src={photo}
            alt="Foto de perfil"
            class={`aspect-square h-32 w-32 rounded-full border border-gray-200 object-cover ${isHiddenPhoto}`}
            id="photo-profile"
            data-has-existing-photo={String(!hasPhoto)}
            data-original-photo={photo}
          />

          <div
            class={`flex aspect-square h-32 w-32 items-center justify-center rounded-full border border-gray-200 bg-linear-to-bl from-custom-blue3/30 to-custom-blue2/30 object-cover text-5xl font-semibold ${isHiddenPhoto ? '' : 'hidden'}`}
            id="initials-profile"
          >
            {initials}
          </div>

          <div class="w-11/12 overflow-hidden md:w-auto">
            <div class="flex items-center gap-2">
              <label class="black cursor-pointer rounded-lg bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200">
                <span class="sr-only">Cambiar foto</span>
                <input type="file" form="form-profile" accept="image/jpeg, image/png" name="img_profile_file" class="cursor-pointer" />
              </label>
              <button
                type="button"
                id="remove-photo-btn"
                class={`rounded-lg bg-red-50 px-2 py-2 text-red-600 transition-colors hover:bg-red-100 ${isHiddenPhoto ? 'hidden' : ''}`}
                title="Eliminar foto"
              >
                <Icon name="Trash" class="size-5" stroke-width={1.5} />
              </button>
            </div>
            <p class="mt-2 text-sm">JPEG, PNG. Máximo 5MB.</p>
          </div>
        </div>
        <div class="mt-7 border-t border-gray-200 pt-6">
          <div class="flex justify-end lg:w-2/3">
            <Button type="submit" size="sm" form="form-profile" loadingText="Cambiando foto..." id="change-photo-btn"> Cambiar foto </Button>
          </div>
        </div>
      </section>

      <form class="mb-10" id="form-profile">
        <div class="rounded-lg border border-gray-200 bg-white p-6 shadow shadow-custom-blue3/20">
          <div class="mb-5 border-b border-gray-200 pb-6">
            <h2 class="text-lg font-semibold">Información personal</h2>
          </div>
          <div class="space-y-3 lg:w-2/3">
            <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
              <div>
                <Input label="Nombre" type="text" name="name" id="name" value={name} />
              </div>
              <div>
                <Input label="Apellido" type="text" name="last_name" id="last_name" value={lastName} />
              </div>
            </div>

            <div>
              <Input label="Correo" type="email" name="email" id="email" value={email} />
            </div>

            <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
              <div class="col-span-2 md:col-span-1">
                <Input label="Código postal" type="number" name="zip_code" id="zip_code" value={zip_code} />
              </div>
              <div class="col-span-2">
                <Select label="País" name="country" value={country} options={countries} placeholder="País" />
              </div>
            </div>
          </div>
          <div class="mt-7 border-t border-gray-200 pt-6">
            <div class="flex justify-end lg:w-2/3">
              <Button type="submit" size="sm" id="save-changes-btn" loadingText="Guardando cambios..."> Guardar cambios </Button>
            </div>
          </div>
        </div>
      </form>

      <form class="mb-10" id="form-reset-password">
        <div class="rounded-lg border border-gray-200 bg-white p-6 shadow shadow-custom-blue3/20">
          <div class="mb-5 border-b border-gray-200 pb-6">
            <h2 class="text-lg font-semibold">Cambiar contraseña</h2>
          </div>
          <div class="space-y-3 lg:w-2/3">
            <p class="text-sm text-neutral-500">Te enviaremos un correo para que puedas cambiar tu contraseña.</p>

            <Input readonly label="Correo electrónico asociado" value={email} type="email" name="email" id="email" />
          </div>
          <div class="mt-7 border-t border-gray-200 pt-6">
            <div class="flex justify-end lg:w-2/3">
              <Button type="submit" size="sm" id="reset-password-btn" loadingText="Enviando correo..."> Enviar correo </Button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</MainLayout>

<script>
  import { actions } from 'astro:actions'
  import { toast } from '@/scripts/toast'
  import { callAction, setButtonLoading, validateImage } from '@/scripts/utils'

  const validateImageProfile = (valueImgProfileFile: File) => {
    const { valid, messages } = validateImage(valueImgProfileFile)
    if (!valid) {
      toast.error(messages)
      return false
    }
    return true
  }

  const updateUser = async (e: Event) => {
    e.preventDefault()
    const form = e.currentTarget as HTMLFormElement
    const dataForm = new FormData(form)

    const imgProfileFile = dataForm.get('img_profile_file') as File
    const photoProfile = document.getElementById('photo-profile') as HTMLImageElement
    const hasExistingPhoto = photoProfile?.dataset.hasExistingPhoto === 'true'

    if (imgProfileFile.size > 0 || !hasExistingPhoto) {
      if (!validateImageProfile(imgProfileFile)) return
    }

    if (imgProfileFile.size === 0) {
      dataForm.delete('img_profile_file')
    }

    setButtonLoading('#save-changes-btn', true)
    setButtonLoading('#change-photo-btn', true)
    const { data, error } = await callAction(actions.user.update(dataForm))

    if (error) {
      toast.error(error.message)
      setButtonLoading('#save-changes-btn', false)
      setButtonLoading('#change-photo-btn', false)
      return
    }

    setButtonLoading('#save-changes-btn', false)
    setButtonLoading('#change-photo-btn', false)
    toast.success(data.message)

    const inputs = form.querySelectorAll('input')
    inputs.forEach((input) => {
      input.value = (data.data[input.name as keyof typeof data.data] as string) ?? ''
    })
    const selects = form.querySelectorAll('select')
    selects.forEach((select) => {
      select.value = data.data[select.name as keyof typeof data.data] as string
    })
  }

  const resendToken = async (e: Event) => {
    e.preventDefault()
    const formResetPassword = e.currentTarget as HTMLFormElement
    const dataForm = new FormData(formResetPassword)
    setButtonLoading('#reset-password-btn', true)
    const { data, error } = await callAction(actions.auth.resetPassword(dataForm))

    if (error) {
      toast.error(error.message)
      setButtonLoading('#reset-password-btn', false)
      return
    }

    toast.success(data.message)
    setButtonLoading('#reset-password-btn', false)
    formResetPassword.reset()
  }

  const updatePhotoProfile = (e: Event) => {
    const target = e.target as HTMLInputElement
    const valueImgProfileFile = target.files?.[0] as File
    const photoProfile = document.getElementById('photo-profile') as HTMLImageElement
    const initialsProfile = document.getElementById('initials-profile') as HTMLDivElement
    const removePhotoBtn = document.getElementById('remove-photo-btn') as HTMLButtonElement
    const originalPhoto = photoProfile?.dataset.originalPhoto || ''
    const hasExistingPhoto = photoProfile?.dataset.hasExistingPhoto === 'true'

    if (valueImgProfileFile) {
      if (!validateImageProfile(valueImgProfileFile)) return
      photoProfile.src = URL.createObjectURL(valueImgProfileFile)
      initialsProfile.classList.add('hidden')
      photoProfile.classList.remove('hidden')
      removePhotoBtn?.classList.remove('hidden')
    } else {
      if (hasExistingPhoto && originalPhoto) {
        photoProfile.src = originalPhoto
        initialsProfile.classList.add('hidden')
        photoProfile.classList.remove('hidden')
        removePhotoBtn?.classList.remove('hidden')
      } else {
        photoProfile.src = ''
        initialsProfile.classList.remove('hidden')
        photoProfile.classList.add('hidden')
        removePhotoBtn?.classList.add('hidden')
      }
    }
  }

  const removePhoto = () => {
    const photoProfile = document.getElementById('photo-profile') as HTMLImageElement
    const initialsProfile = document.getElementById('initials-profile') as HTMLDivElement
    const fileInput = document.querySelector('input[name="img_profile_file"]') as HTMLInputElement
    const removePhotoBtn = document.getElementById('remove-photo-btn') as HTMLButtonElement

    if (fileInput) fileInput.value = ''

    photoProfile.src = ''
    photoProfile.classList.add('hidden')
    initialsProfile.classList.remove('hidden')

    removePhotoBtn?.classList.add('hidden')
  }

  document.addEventListener('astro:page-load', () => {
    const form = document.getElementById('form-profile')
    const formResetPassword = document.getElementById('form-reset-password')
    const photoProfileInput = document.querySelector('input[name="img_profile_file"]')
    const removePhotoBtn = document.getElementById('remove-photo-btn')

    if (form) form.addEventListener('submit', updateUser)
    if (formResetPassword) formResetPassword.addEventListener('submit', resendToken)
    if (photoProfileInput) photoProfileInput.addEventListener('input', updatePhotoProfile)
    if (removePhotoBtn) removePhotoBtn.addEventListener('click', removePhoto)
  })
</script>
