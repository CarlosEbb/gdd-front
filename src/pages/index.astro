---
import AuthLayout from '@/layouts/AuthLayout.astro'
import Input from '@/components/form/Input.astro'
import Button from '@/components/ui/Button.astro'

const remembered = Astro.cookies.get('remembered_username')?.value ?? ''
const isRemembered = Astro.cookies.has('remembered_username') ?? ''
---

<AuthLayout titleTabBrowser="Iniciar sesión" titleCardAuth="Ingresa tu información">
  <form method="POST" id="form-login" class="space-y-3">
    <Input label="Usuario / Correo" name="email" value={remembered} type="email" placeholder="correo@dominio.com" required />
    <Input label="Contraseña" name="password" type="password" placeholder="••••••••" required />

    <div class="mt-3 flex items-center justify-between gap-3 sm:mb-1 md:mt-4 lg:mb-4 xl:mb-8">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <input id="remember-me" checked={isRemembered} name="remember-me" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
          <label for="remember-me" class="ml-2 block text-sm text-gray-800">Recuérdame</label>
        </div>
      </div>
      <a href="/forgot-password" class="text-sm text-blue-600 hover:text-blue-700 hover:underline"> ¿Olvidaste tu contraseña? </a>
    </div>

    <div class="space-y-4">
      <Button id="btn-login" variant="gradient" class="w-full" loadingText="Iniciando sesión..."> Iniciar sesión </Button>
      <div class="relative">
        <div class="absolute inset-0 flex items-center">
          <span class="w-full border-t border-gray-200"></span>
        </div>
        <div class="relative flex justify-center text-xs uppercase">
          <span class="bg-linear-to-br from-blue-50/50 via-purple-50/30 to-white px-2"> O </span>
        </div>
      </div>
      <div class="pt-2 text-center">
        <p class="text-sm">
          ¿No tienes una cuenta?
          <a href="/register" class="font-medium text-blue-600 hover:text-blue-700 hover:underline"> Regístrate aquí </a>
        </p>
      </div>
    </div>
  </form>
</AuthLayout>

<script>
  import { navigate } from 'astro:transitions/client'
  import { actions } from 'astro:actions'
  import { toast } from '@/scripts/toast.ts'
  import { deleteCookie, setCookie, setButtonLoading } from '@/scripts/utils'

  document.addEventListener('astro:page-load', () => {
    const formLogin = document.getElementById('form-login') as HTMLFormElement
    if (!formLogin) return

    const handleSubmit = async (event: Event) => {
      event.preventDefault()
      const formData = new FormData(formLogin)
      const remember = !!formData.get('remember-me')
      const email = formData.get('email') as string

      setButtonLoading('#btn-login', true)
      const { data, error } = await actions.auth.login(formData)

      if (error) {
        toast.error(error.message)
        setButtonLoading('#btn-login', false)
        return
      }

      if (remember) {
        setCookie({ name: 'remembered_username', value: email, days: 30 })
      } else {
        deleteCookie('remembered_username')
      }

      toast.success(data?.message ?? '')
      navigate(data?.data?.redirect ?? '/')
    }

    formLogin.addEventListener('submit', handleSubmit)
  })
</script>
