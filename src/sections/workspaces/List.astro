---
import Input from '@/components/form/Input.astro'
import Modal from '@/components/modal/Modal.astro'
import Button from '@/components/ui/Button.astro'
import IconPicker from '@/components/ui/IconPicker.astro'
import WorkspacesLink from '@/components/ui/WorkspacesLink.astro'
import { Plus } from '@lucide/astro'

const workspaces = (await Astro.session?.get('workspaces')) || []
const latestWorkspaces = workspaces.toReversed().slice(0, 3)
const hasWorkSpaces = workspaces.length > 0
---

<section class="mb-10">
  <h2 class="mb-4 text-lg font-semibold text-gray-700">Espacios de trabajo</h2>
  <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
    {hasWorkSpaces && latestWorkspaces.map((workspace, index) => <WorkspacesLink workspace={workspace} index={index} />)}

    <button
      data-open-modal="create-workspace"
      class="flex h-20 cursor-pointer items-center gap-3 rounded-lg border-2 border-dashed border-gray-300 bg-white p-3 text-center text-gray-500 transition-all hover:border-purple-400 hover:text-purple-600 md:h-24 md:p-4"
    >
      <div class="flex items-center justify-center rounded-lg bg-neutral-100 p-2 md:p-3">
        <Plus class="size-6 md:size-8" />
      </div>
      <span class="font-semibold">Crear nuevo</span>
    </button>
  </div>
</section>

<Modal modalId="create-workspace" title="Crear nuevo espacio de trabajo">
  <form class="space-y-6" id="create-workspace-form">
    <div>
      <Input label="Nombre del espacio de trabajo" data-error-required="El nombre del espacio de trabajo es obligatorio" type="text" id="name" name="name" placeholder="Ingresa el nombre" required />
    </div>

    <IconPicker />

    <div class="flex justify-end space-x-4 border-t border-gray-200 pt-4">
      <Button type="button" size="sm" variant="outline" data-close-modal>Cancelar</Button>
      <Button type="submit" size="sm" id="btn-create-workspace" loadingText="Creando espacio...">Crear espacio</Button>
    </div>
  </form>
</Modal>

<script>
  import { toast } from '@/scripts/toast'
  import { actions } from 'astro:actions'
  import { navigate } from 'astro:transitions/client'
  import { callAction, setButtonLoading } from '@/scripts/utils'


  document.addEventListener('astro:page-load', () => {
    const form = document.getElementById('create-workspace-form') as HTMLFormElement
    const modal = document.getElementById('create-workspace') as HTMLDialogElement

    const handleSubmit = async (e: Event) => {
      e.preventDefault()
      const dataForm = new FormData(form)
      setButtonLoading('#btn-create-workspace', true)
      const { data, error } = await callAction(actions.workspaces.create(dataForm))

      if (error) {
        toast.error(error.message)
        setButtonLoading('#btn-create-workspace', false)
        return
      }

      toast.success(data.message)
      navigate(`/workspaces/${data.data.uuid}`)
      modal.close()
    }
    form.addEventListener('submit', handleSubmit)
  })
</script>
