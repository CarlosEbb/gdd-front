---
import Modal from './Modal.astro'
import Select from '../form/Select.astro'
import Input from '../form/Input.astro'
import Button from '../ui/Button.astro'
import Icon from '../ui/Icon.astro'

const workspaces = (await Astro.session?.get('workspaces')) || []
---

<Modal modalId="save-template" title="Crear documento">
  <form class="space-y-6" id="save-template-form">
    <div>
      <Select
        label="Espacio de trabajo"
        name="uuid_workspace"
        placeholder="Seleccione un espacio de trabajo"
        options={workspaces.map((workspace) => ({ value: workspace.uuid, label: workspace.name }))}
        required
      />
    </div>

    <div>
      <Input label="Nombre" name="title" placeholder="Ingrese el nombre del documento" required />
    </div>

    <div>
      <Input label="Descripción" name="description" placeholder="Ingrese la descripción del documento" required />
    </div>

    <div class="hidden" id="prompt-container">
      <Input label="Crear documento con IA" name="prompt" placeholder="Ingrese un prompt para crear el documento con IA" />
      <p class="text-sm text-gray-500">Ingrese el prompt para crear el documento con IA.</p>
    </div>

    <div class="mt-2 w-full">
      <Button variant="gradient" size="sm" id="btn-generate-with-ia" type="button">
        <span class="flex items-center">
          <Icon name="Sparkles" class="me-2 size-4" stroke-width={1.5} />
          <span class="text-sm">Generar con IA</span>
        </span>
      </Button>
    </div>

    <div class="flex justify-end space-x-4 border-t border-gray-200 pt-4">
      <Button type="button" size="sm" variant="outline" data-close-modal>Cancelar</Button>
      <Button type="submit" size="sm" id="btn-save-template" loadingText="Creando documento...">Crear documento</Button>
    </div>
  </form>
</Modal>

<script>
  import { actions } from 'astro:actions'
  import { navigate } from 'astro:transitions/client'
  import { callAction, setButtonLoading } from '@/scripts/utils'
  import { toast } from '@/scripts/toast'

  function initializeCreateDocumentModal() {
    const modalSaveTemplate = document.getElementById('save-template') as HTMLDialogElement
    const form = document.getElementById('save-template-form') as HTMLFormElement
    const btnGenerateWithIA = document.getElementById('btn-generate-with-ia') as HTMLButtonElement
    const promptContainer = document.getElementById('prompt-container') as HTMLDivElement

    if (!form) return

    const handleSaveTemplate = async (e: Event) => {
      e.preventDefault()

      const formData = new FormData(form)
      const name = (formData.get('title') as string)
        .toLowerCase()
        .replace(/ /g, '_')
        .replace(/[^a-z0-9_]/g, '')
      formData.append('name', name)

      try {
        setButtonLoading('#btn-save-template', true)
        const { data, error } = await callAction(actions.documents.createTemplate(formData))

        if (error) {
          toast.error(error.message)
          setButtonLoading('#btn-save-template', false)
          return
        }

        toast.success(data.message)
        navigate(`/editor/${data.data.template.uuid}?build_number=${data.data.version.build_number}&id_workspace=${data.data.template.id_workspace}&name_document=${data.data.template.title}`)
        modalSaveTemplate.close()
      } catch (error: unknown) {
        if (error instanceof Error) {
          toast.error(error.message)
        } else {
          toast.error('Error al guardar la plantilla')
        }
        modalSaveTemplate.close()
      } finally {
        setButtonLoading('#btn-save-template', false)
      }
    }

    const handleGenerateWithIA = async (e: Event) => {
      promptContainer.classList.toggle('hidden')
    }

    btnGenerateWithIA.addEventListener('click', handleGenerateWithIA)

    form.addEventListener('submit', handleSaveTemplate)
  }

  document.addEventListener('astro:page-load', () => {
    initializeCreateDocumentModal()
  })
</script>
